name: Destroy Admin Panel Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm deletion of all resources'
        required: true
        type: string

jobs:
  destroy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Validate confirmation
      run: |
        if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
          echo "âŒ Confirmation failed. You must type 'DESTROY' to proceed."
          exit 1
        fi
        echo "âœ… Confirmation validated. Proceeding with destruction..."
        
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.5.0'
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Empty S3 bucket before destruction
      run: |
        cd infrastructure
        terraform init
        BUCKET_NAME=$(terraform output -raw admin_panel_bucket_name 2>/dev/null || echo "cognito-admin-panel-vpc-private")
        echo "ğŸ—‘ï¸ Emptying S3 bucket: $BUCKET_NAME"
        aws s3 rm s3://$BUCKET_NAME --recursive || echo "Bucket already empty or doesn't exist"
        
    - name: Destroy infrastructure
      run: |
        cd infrastructure
        echo "ğŸš¨ DESTROYING ALL INFRASTRUCTURE..."
        terraform destroy -auto-approve
        
    - name: Cleanup confirmation
      run: |
        echo "ğŸ’¥ DESTRUCTION COMPLETE!"
        echo "ğŸ—‘ï¸ All AWS resources have been deleted"
        echo "ğŸ’° No more charges will be incurred"
        echo "âš ï¸ This action cannot be undone"