name: Destroy Admin Panel Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm deletion of all resources'
        required: true
        type: string

jobs:
  destroy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Validate confirmation
      run: |
        if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
          echo "âŒ Confirmation failed. You must type 'DESTROY' to proceed."
          exit 1
        fi
        echo "âœ… Confirmation validated. Proceeding with destruction..."
        
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.5.0'
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Import existing resources and destroy
      run: |
        cd infrastructure
        terraform init
        
        # Try to import existing resources based on terraform.tfvars
        echo "ğŸ” Checking for existing resources..."
        
        # Empty S3 bucket first
        BUCKET_NAME="cognito-admin-panel-vpc-private"
        echo "ğŸ—‘ï¸ Emptying S3 bucket: $BUCKET_NAME"
        aws s3 rm s3://$BUCKET_NAME --recursive 2>/dev/null || echo "Bucket already empty or doesn't exist"
        
        # Try to destroy with terraform
        echo "ğŸš¨ DESTROYING ALL INFRASTRUCTURE..."
        terraform destroy -auto-approve || echo "Nothing to destroy or resources already deleted"
        
        # Manual cleanup of remaining resources
        echo "ğŸ§¹ Manual cleanup of any remaining resources..."
        
        # Delete Lambda function
        aws lambda delete-function --function-name admin-panel-api 2>/dev/null || echo "Lambda function not found"
        
        # Delete API Gateway - fix the query
        API_IDS=$(aws apigateway get-rest-apis --query "items[?name=='admin-panel-api'].id" --output text 2>/dev/null)
        for API_ID in $API_IDS; do
          if [ "$API_ID" != "" ] && [ "$API_ID" != "None" ]; then
            echo "Deleting API Gateway: $API_ID"
            aws apigateway delete-rest-api --rest-api-id $API_ID 2>/dev/null || echo "Failed to delete API Gateway $API_ID"
          fi
        done
        
        # Delete S3 bucket
        aws s3 rb s3://$BUCKET_NAME --force 2>/dev/null || echo "S3 bucket not found"
        
        # Delete DynamoDB table
        aws dynamodb delete-table --table-name admin-credentials 2>/dev/null || echo "DynamoDB table not found"
        
        # Delete VPC endpoints
        echo "ğŸ”— Cleaning up VPC endpoints..."
        VPC_ID="vpc-0f1991d5da5940d21"
        
        # Delete S3 VPC endpoint
        S3_ENDPOINT=$(aws ec2 describe-vpc-endpoints --filters "Name=vpc-id,Values=$VPC_ID" "Name=service-name,Values=com.amazonaws.us-east-1.s3" --query "VpcEndpoints[0].VpcEndpointId" --output text 2>/dev/null)
        if [ "$S3_ENDPOINT" != "" ] && [ "$S3_ENDPOINT" != "None" ]; then
          aws ec2 delete-vpc-endpoint --vpc-endpoint-id $S3_ENDPOINT 2>/dev/null || echo "S3 VPC endpoint not found"
        fi
        
        # Delete API Gateway VPC endpoint
        API_ENDPOINT=$(aws ec2 describe-vpc-endpoints --filters "Name=vpc-id,Values=$VPC_ID" "Name=service-name,Values=com.amazonaws.us-east-1.execute-api" --query "VpcEndpoints[0].VpcEndpointId" --output text 2>/dev/null)
        if [ "$API_ENDPOINT" != "" ] && [ "$API_ENDPOINT" != "None" ]; then
          aws ec2 delete-vpc-endpoint --vpc-endpoint-id $API_ENDPOINT 2>/dev/null || echo "API Gateway VPC endpoint not found"
        fi
        
        echo "âœ… Manual cleanup completed"
        
    - name: Cleanup confirmation
      run: |
        echo "ğŸ’¥ DESTRUCTION COMPLETE!"
        echo "ğŸ—‘ï¸ All AWS resources have been deleted"
        echo "ğŸ’° No more charges will be incurred"
        echo "âš ï¸ This action cannot be undone"